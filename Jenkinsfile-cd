#!groovy

node('ansible-master') {
    

    def artServer = Artifactory.newServer url: '"$ATF_URL"', credentialsId: 'GLOBAL-ARTIFACTORY';
    
    def version;
    def artifactId;
    def groupId;

    stage('download artifacts'){
        def downloadSpec = """{
            "files": [
                {
                    "pattern": "app/com/cfets/devops/ansible-maven-sample/*",
                    "build": "$build_name/$build_number",
                }
            ]
        }"""
        artServer.download(downloadSpec);
        sh 'tar -zxvf *.tar.gz'

    }
    
   stage('deploy'){
        ansiblePlaybook colorized: true, credentialsId: 'ansible-slave', extras: '-e app_version="$verison" -e app_user_password="${app_user_password}"', inventory: 'ansible-maven-sample-${version}/deploy/inventories/stage/hosts', playbook: 'ansible-maven-sample-${version}/deploy/app.yml', sudoUser: null
   }

    
    
}
